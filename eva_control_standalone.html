<script>
const WS_PORT = 8765;
let ws = null;
let connected = false;
let robotIP = localStorage.getItem('robotIP') || '';

const robotIPInput = document.getElementById('robot-ip');
const btnConnect = document.getElementById('btn-connect');
const statusText = document.getElementById('status-text');
const statusDot = document.getElementById('status-dot');
const cameraFeed = document.getElementById('camera-feed');
const cameraBadge = document.getElementById('camera-badge');
const cameraName = document.getElementById('camera-name');

if (robotIP) robotIPInput.value = robotIP;

btnConnect.onclick = () => {
    const ip = robotIPInput.value.trim();
    if (!ip) return alert("Digite o IP");
    localStorage.setItem("robotIP", ip);
    robotIP = ip;
    connect();
};

function connect(){
    if(ws) ws.close();
    ws = new WebSocket(`ws://${robotIP}:${WS_PORT}`);

    ws.onopen = ()=>{
        connected=true;
        statusText.textContent="Conectado";
        statusDot.classList.add("connected");
    };

    ws.onclose = ()=>{
        connected=false;
        statusText.textContent="Desconectado";
        statusDot.classList.remove("connected");
    };

    ws.onmessage = e=>{
        const msg = JSON.parse(e.data);
        if(msg.type==="camera_frame"){
            cameraFeed.src = "data:image/jpeg;base64,"+msg.data;
            cameraName.textContent = msg.camera;
            cameraBadge.textContent = msg.camera;
        }
    };
}

function send(cmd, params={}){
    if(connected) ws.send(JSON.stringify({cmd, params}));
}

document.getElementById("btn-forward").onmousedown=()=>send("drive",{vx:0.5});
document.getElementById("btn-backward").onmousedown=()=>send("drive",{vx:-0.5});
document.getElementById("btn-left").onmousedown=()=>send("drive",{vz:0.5});
document.getElementById("btn-right").onmousedown=()=>send("drive",{vz:-0.5});
document.getElementById("btn-stop").onclick=()=>send("stop");

document.getElementById("btn-camera-usb").onclick=()=>send("camera",{action:"force",camera:"usb"});
document.getElementById("btn-camera-picam").onclick=()=>send("camera",{action:"force",camera:"picam"});
document.getElementById("btn-disable-arm").onclick=()=>send("camera",{action:"disable_arm"});

["base","shoulder","elbow","head"].forEach((id,i)=>{
    const slider=document.getElementById(id+"-slider");
    slider.oninput=e=>{
        send("servo",{channel:i,angle:parseInt(e.target.value)});
    };
});
</script>
